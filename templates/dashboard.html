<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FichasIA â€” Panel</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap');

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #0c0c0c;
  --surface:   #141414;
  --surface2:  #1a1a1a;
  --border:    #222;
  --border2:   #2c2c2c;
  --text:      #e8e2d9;
  --muted:     #666;
  --muted2:    #333;
  --accent:    #c9392c;
  --blue:      #1e4aab;
  --blue-soft: rgba(30,74,171,0.14);
  --green:     #25D366;
  --gold:      #c9a96e;
  --sidebar:   240px;
}

html { height: 100%; }

body {
  min-height: 100%;
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 400;
  -webkit-font-smoothing: antialiased;
  display: flex;
}

/* â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â• */
.sidebar {
  width: var(--sidebar);
  min-width: var(--sidebar);
  max-width: var(--sidebar);
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  height: 100vh;
  position: sticky;
  top: 0;
  overflow-y: auto;
  flex-shrink: 0;
}

.sb-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 22px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.sb-icon {
  width: 30px;
  height: 30px;
  background: var(--accent);
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: 'DM Serif Display', serif;
  font-size: 16px;
  color: white;
  flex-shrink: 0;
}

.sb-name {
  font-family: 'DM Serif Display', serif;
  font-size: 18px;
  color: var(--text);
  letter-spacing: -0.02em;
}

.sb-body { flex: 1; padding: 8px 10px; overflow-y: auto; }

.sb-section {
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted2);
  padding: 14px 10px 6px;
}

.nav-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  padding: 9px 12px;
  border: none;
  background: none;
  color: var(--muted);
  font-family: 'DM Sans', sans-serif;
  font-size: 13.5px;
  font-weight: 400;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s;
  text-align: left;
  margin-bottom: 1px;
}

.nav-btn:hover { background: var(--surface2); color: var(--text); }
.nav-btn.active { background: var(--blue-soft); color: #7fa0e8; font-weight: 500; }
.nav-icon { font-size: 14px; flex-shrink: 0; }

.sb-footer {
  border-top: 1px solid var(--border);
  padding: 14px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.user-av {
  width: 30px;
  height: 30px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--blue));
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  color: white;
  flex-shrink: 0;
}

.user-meta { flex: 1; min-width: 0; }
.user-name { font-size: 12.5px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.user-role { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; margin-top: 1px; }

.logout-btn {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 16px;
  padding: 5px;
  border-radius: 4px;
  transition: color 0.15s;
  text-decoration: none;
  display: flex;
  align-items: center;
  flex-shrink: 0;
}
.logout-btn:hover { color: var(--accent); }

/* â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â• */
.main {
  flex: 1;
  min-width: 0;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.topbar {
  background: var(--bg);
  border-bottom: 1px solid var(--border);
  padding: 16px 32px;
  flex-shrink: 0;
}

.page-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px;
  color: var(--text);
  letter-spacing: -0.02em;
}

.page-sub {
  font-size: 12px;
  color: var(--muted);
  margin-top: 3px;
}

.content {
  flex: 1;
  padding: 28px 32px;
  width: 100%;
}

/* â•â•â•â•â•â•â•â•â•â• PANELES â•â•â•â•â•â•â•â•â•â• */
.panel { display: none; width: 100%; }
.panel.active { display: block; animation: fadeIn .2s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

/* â•â•â•â•â•â•â•â•â•â• CARD â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 24px;
  margin-bottom: 16px;
  width: 100%;
}

.card-label {
  display: block;
  font-size: 10px;
  font-weight: 600;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  padding-bottom: 14px;
  margin-bottom: 18px;
  border-bottom: 1px solid var(--border);
}

/* â•â•â•â•â•â•â•â•â•â• FORM â•â•â•â•â•â•â•â•â•â• */
.field-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-bottom: 14px;
}

.field-grid.one { grid-template-columns: 1fr; }

.field { display: flex; flex-direction: column; gap: 6px; }

.field-label {
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--muted);
}

.input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: 6px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  font-weight: 400;
  padding: 10px 13px;
  outline: none;
  transition: border-color .2s, box-shadow .2s;
}

.input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(30,74,171,.12);
}

.input::placeholder { color: #2e2e2e; }

.url-input {
  width: 100%;
  background: var(--bg);
  border: 1px solid var(--border2);
  border-radius: 8px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: 14px;
  padding: 14px 16px;
  outline: none;
  transition: border-color .25s, box-shadow .25s;
  margin-bottom: 18px;
}

.url-input:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 4px rgba(30,74,171,.12);
}

.url-input::placeholder { color: #2e2e2e; font-size: 13px; }

/* â•â•â•â•â•â•â•â•â•â• BOTONES â•â•â•â•â•â•â•â•â•â• */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: 7px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13.5px;
  font-weight: 500;
  cursor: pointer;
  border: none;
  transition: all .15s;
}

.btn:disabled { opacity: .5; cursor: not-allowed; }

.btn-primary { background: var(--blue); color: white; }
.btn-primary:hover:not(:disabled) { background: #2454c7; transform: translateY(-1px); box-shadow: 0 4px 14px rgba(30,74,171,.3); }

.btn-ghost { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
.btn-ghost:hover { background: var(--border2); }

.btn-green { background: var(--green); color: white; }
.btn-green:hover:not(:disabled) { background: #1aab50; transform: translateY(-1px); }

.btn-full { width: 100%; padding: 14px; font-size: 15px; font-weight: 600; margin-top: 8px; }

.btn-row { display: flex; gap: 10px; }

/* â•â•â•â•â•â•â•â•â•â• LOG â•â•â•â•â•â•â•â•â•â• */
.log-head { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
.log-title { font-size: 12.5px; font-weight: 500; }

.log-box {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-family: 'Courier New', monospace;
  font-size: 12px;
  color: #4ade80;
  padding: 14px 16px;
  height: 200px;
  overflow-y: auto;
  white-space: pre-wrap;
  line-height: 1.7;
}

/* â•â•â•â•â•â•â•â•â•â• RESULTADO â•â•â•â•â•â•â•â•â•â• */
.result-box {
  background: rgba(30,74,171,.07);
  border: 1px solid rgba(30,74,171,.2);
  border-radius: 7px;
  padding: 14px 16px;
  margin-bottom: 14px;
}
.result-lbl { font-size: 11px; color: var(--muted); margin-bottom: 5px; }
.result-link { color: #7fa0e8; font-size: 13px; word-break: break-all; }

/* â•â•â•â•â•â•â•â•â•â• SPINNER â•â•â•â•â•â•â•â•â•â• */
.spinner {
  border: 2px solid var(--border2);
  border-top-color: var(--blue);
  border-radius: 50%;
  width: 14px;
  height: 14px;
  animation: spin .7s linear infinite;
  flex-shrink: 0;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â•â•â•â•â•â•â•â•â•â• TABLA USUARIOS â•â•â•â•â•â•â•â•â•â• */
.admin-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
.admin-head-left h2 { font-family: 'DM Serif Display', serif; font-size: 20px; color: var(--text); }
.admin-head-left p { font-size: 12px; color: var(--muted); margin-top: 3px; }

.user-table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
.user-table th {
  text-align: left;
  font-size: 10px; font-weight: 600;
  letter-spacing: .1em; text-transform: uppercase;
  color: var(--muted);
  padding: 0 12px 12px;
  border-bottom: 1px solid var(--border);
}
.user-table td { padding: 13px 12px; border-bottom: 1px solid var(--border); vertical-align: middle; }
.user-table tr:last-child td { border-bottom: none; }
.user-table tr:hover td { background: rgba(255,255,255,.015); }

.badge {
  display: inline-flex;
  align-items: center;
  font-size: 10px; font-weight: 600;
  letter-spacing: .06em; text-transform: uppercase;
  padding: 3px 9px; border-radius: 20px;
}
.badge-admin  { background: rgba(201,169,110,.12); color: var(--gold); }
.badge-user   { background: rgba(30,74,171,.15);   color: #7fa0e8; }
.badge-active { background: rgba(37,211,102,.12);  color: #4ade80; }
.badge-off    { background: rgba(255,255,255,.04);  color: var(--muted); }

/* â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â• */
.note { font-size: 11.5px; color: var(--muted); line-height: 1.5; margin-top: 5px; }
.note a { color: #7fa0e8; }
.divider { height: 1px; background: var(--border); margin: 20px 0; }
.mt-4 { margin-top: 16px; }
.mb-3 { margin-bottom: 12px; }
.mb-4 { margin-bottom: 16px; }

/* â•â•â•â•â•â•â•â•â•â• MODAL â•â•â•â•â•â•â•â•â•â• */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.75);
  z-index: 200;
  display: flex; align-items: center; justify-content: center;
  padding: 24px;
  opacity: 0; pointer-events: none;
  transition: opacity .2s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal-box {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 10px;
  width: 100%; max-width: 420px;
  padding: 28px;
  animation: fadeIn .2s ease;
}
.modal-title { font-family: 'DM Serif Display', serif; font-size: 20px; color: var(--text); margin-bottom: 20px; }

/* â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â• */
.toast {
  position: fixed; bottom: 28px; right: 28px; z-index: 500;
  background: var(--surface); border: 1px solid var(--border2);
  border-radius: 7px; padding: 13px 18px;
  font-size: 13px; color: var(--text);
  display: flex; align-items: center; gap: 10px;
  box-shadow: 0 8px 32px rgba(0,0,0,.5);
  transform: translateY(80px); opacity: 0;
  transition: all .3s cubic-bezier(.22,1,.36,1);
  min-width: 220px;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.ok  { border-left: 3px solid #4ade80; }
.toast.err { border-left: 3px solid var(--accent); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<aside class="sidebar">
  <div class="sb-brand">
    <div class="sb-icon">F</div>
    <div class="sb-name">FichasIA</div>
  </div>

  <div class="sb-body">
    <div class="sb-section">Herramientas</div>
    <button class="nav-btn active" onclick="showPanel('generar', this)">
      <span class="nav-icon">ğŸ </span> Generar ficha
    </button>

    <div class="sb-section">Cuenta</div>
    <button class="nav-btn" onclick="showPanel('perfil', this)">
      <span class="nav-icon">âš™ï¸</span> Mi perfil
    </button>
    <button class="nav-btn" onclick="showPanel('pass', this)">
      <span class="nav-icon">ğŸ”‘</span> ContraseÃ±a
    </button>

    {% if is_admin %}
    <div class="sb-section">Admin</div>
    <button class="nav-btn" onclick="showPanel('usuarios', this); cargarUsuarios()">
      <span class="nav-icon">ğŸ‘¥</span> Usuarios
    </button>
    {% endif %}
  </div>

  <div class="sb-footer">
    <div class="user-av">{{ (user.nombre or username)[0].upper() }}</div>
    <div class="user-meta">
      <div class="user-name">{{ user.nombre or username }}</div>
      <div class="user-role">{{ user.role }}</div>
    </div>
    <a href="/logout" class="logout-btn" title="Cerrar sesiÃ³n">â†©</a>
  </div>
</aside>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="main">
  <div class="topbar">
    <div class="page-title" id="page-title">Generador de Fichas</div>
    <div class="page-sub" id="page-sub">PegÃ¡ el link y en minutos tenÃ©s la ficha lista</div>
  </div>

  <div class="content">

    <!-- â”€â”€ GENERAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="panel active" id="panel-generar">

      <div class="card">
        <span class="card-label">Link de la propiedad</span>
        <input class="url-input" id="url" type="url"
               placeholder="https://www.zonaprop.com.ar/propiedades/...">

        <div class="field-grid">
          <div class="field">
            <span class="field-label">Tu nombre</span>
            <input class="input" id="g_nombre" type="text"
                   value="{{ user.nombre or '' }}" placeholder="Ej: Christian GonzÃ¡lez">
          </div>
          <div class="field">
            <span class="field-label">WhatsApp (sin +)</span>
            <input class="input" id="g_whatsapp" type="text"
                   value="{{ user.whatsapp or '' }}" placeholder="5491130434062">
          </div>
        </div>

        <div class="field-grid">
          <div class="field">
            <span class="field-label">Logo URL</span>
            <input class="input" id="g_logo" type="url"
                   value="{{ user.logo or '' }}" placeholder="https://...">
          </div>
          <div class="field">
            <span class="field-label">Google Form (encuesta)</span>
            <input class="input" id="g_form" type="url"
                   value="{{ user.form_url or '' }}" placeholder="https://forms.gle/...">
          </div>
        </div>

        <button class="btn btn-primary btn-full" id="btn-generar" onclick="generarFicha()">
          ğŸš€ Generar Ficha Ahora
        </button>
      </div>

      <!-- Log -->
      <div class="card" id="log-card" style="display:none">
        <div class="log-head">
          <div class="spinner" id="log-spinner"></div>
          <span class="log-title" id="log-status">Procesando...</span>
        </div>
        <div class="log-box" id="log-box"></div>
      </div>

      <!-- Resultado -->
      <div class="card" id="result-card" style="display:none">
        <span class="card-label">ğŸ‰ Ficha lista para compartir</span>
        <div class="result-box">
          <div class="result-lbl">Link de la ficha:</div>
          <a id="result-link" href="#" target="_blank" class="result-link"></a>
        </div>
        <div class="btn-row">
          <button class="btn btn-ghost" id="btn-copiar" onclick="copiarLink()">ğŸ“‹ Copiar link</button>
          <button class="btn btn-green" onclick="abrirWpp()">ğŸ’¬ Enviar por WhatsApp</button>
        </div>
      </div>

    </div><!-- /panel-generar -->

    <!-- â”€â”€ PERFIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="panel" id="panel-perfil">
      <div class="card" style="max-width:600px">
        <span class="card-label">Datos del agente</span>

        <div class="field-grid mb-3">
          <div class="field">
            <span class="field-label">Nombre completo</span>
            <input class="input" id="p_nombre" type="text"
                   value="{{ user.nombre or '' }}" placeholder="Tu nombre">
          </div>
          <div class="field">
            <span class="field-label">WhatsApp (sin +)</span>
            <input class="input" id="p_whatsapp" type="text"
                   value="{{ user.whatsapp or '' }}" placeholder="5491130434062">
          </div>
        </div>

        <div class="field-grid one mb-3">
          <div class="field">
            <span class="field-label">Logo URL</span>
            <input class="input" id="p_logo" type="url"
                   value="{{ user.logo or '' }}" placeholder="URL de tu logo">
          </div>
        </div>

        <div class="field-grid one mb-4">
          <div class="field">
            <span class="field-label">Google Form (encuesta post-visita)</span>
            <input class="input" id="p_form" type="url"
                   value="{{ user.form_url or '' }}" placeholder="https://forms.gle/...">
            <p class="note">Link del formulario que se incluye en cada ficha generada</p>
          </div>
        </div>

        <div class="divider"></div>

        <div class="field-grid one mb-4">
          <div class="field">
            <span class="field-label">Token de Netlify</span>
            <input class="input" id="p_netlify" type="password"
                   value="{{ user.netlify_token or '' }}" placeholder="nfp_...">
            <p class="note">
              ObtenÃ© el tuyo gratis en
              <a href="https://app.netlify.com/user/applications" target="_blank">
                app.netlify.com â†’ User Settings â†’ Applications â†’ New access token
              </a>
            </p>
          </div>
        </div>

        <button class="btn btn-primary" onclick="guardarPerfil()">Guardar cambios</button>
      </div>
    </div><!-- /panel-perfil -->

    <!-- â”€â”€ CONTRASEÃ‘A â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="panel" id="panel-pass">
      <div class="card" style="max-width:440px">
        <span class="card-label">Cambiar contraseÃ±a</span>
        <div class="field mb-3">
          <span class="field-label">ContraseÃ±a actual</span>
          <input class="input" id="pw_actual" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="field mb-3">
          <span class="field-label">ContraseÃ±a nueva</span>
          <input class="input" id="pw_nueva" type="password" placeholder="MÃ­nimo 6 caracteres">
        </div>
        <div class="field mb-4">
          <span class="field-label">Confirmar contraseÃ±a nueva</span>
          <input class="input" id="pw_confirmar" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" onclick="cambiarPassword()">Actualizar contraseÃ±a</button>
      </div>
    </div>

    <!-- â”€â”€ USUARIOS (admin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    {% if is_admin %}
    <div class="panel" id="panel-usuarios">
      <div class="admin-head">
        <div class="admin-head-left">
          <h2>Usuarios</h2>
          <p>GestionÃ¡ las cuentas de tus agentes</p>
        </div>
        <button class="btn btn-primary" onclick="abrirModalCrear()">+ Nuevo usuario</button>
      </div>
      <div class="card">
        <table class="user-table">
          <thead>
            <tr>
              <th>Agente</th>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="users-body">
            <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:32px">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    {% endif %}

  </div><!-- /content -->
</div><!-- /main -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALES â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
{% if is_admin %}
<div class="modal-overlay" id="modal-crear">
  <div class="modal-box">
    <div class="modal-title">Nuevo usuario</div>
    <div class="field mb-3">
      <span class="field-label">Nombre completo</span>
      <input class="input" id="new_nombre" type="text" placeholder="Christian GonzÃ¡lez">
    </div>
    <div class="field mb-3">
      <span class="field-label">Usuario (para login)</span>
      <input class="input" id="new_user" type="text" placeholder="christiang" autocomplete="off">
    </div>
    <div class="field mb-4">
      <span class="field-label">ContraseÃ±a inicial</span>
      <input class="input" id="new_pass" type="password" placeholder="MÃ­nimo 6 caracteres" autocomplete="off">
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="cerrarModal()">Cancelar</button>
      <button class="btn btn-primary" onclick="crearUsuario()">Crear cuenta</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-reset">
  <div class="modal-box">
    <div class="modal-title">Resetear contraseÃ±a</div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px">
      Nueva contraseÃ±a para <strong id="reset-label" style="color:var(--text)"></strong>
    </p>
    <div class="field mb-4">
      <span class="field-label">Nueva contraseÃ±a</span>
      <input class="input" id="reset_pass" type="password" placeholder="MÃ­nimo 6 caracteres">
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn btn-ghost" onclick="cerrarModalReset()">Cancelar</button>
      <button class="btn btn-primary" onclick="confirmarReset()">Guardar</button>
    </div>
  </div>
</div>
{% endif %}

<div class="toast" id="toast"></div>

<script>
let currentUrl = null;
let resetTarget = null;

const PANELS = {
  generar:  ['Generador de Fichas',   'PegÃ¡ el link y en minutos tenÃ©s la ficha lista'],
  perfil:   ['Mi Perfil',             'ConfigurÃ¡ tus datos y token de Netlify'],
  pass:     ['ContraseÃ±a',            'ActualizÃ¡ tu contraseÃ±a de acceso'],
  usuarios: ['Usuarios',              'GestionÃ¡ las cuentas de tus agentes'],
};

function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const el = document.getElementById('panel-' + id);
  if (el) el.classList.add('active');
  if (btn) btn.classList.add('active');
  const m = PANELS[id];
  if (m) {
    document.getElementById('page-title').textContent = m[0];
    document.getElementById('page-sub').textContent   = m[1];
  }
}

function toast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = (type === 'ok' ? 'âœ“  ' : 'âœ—  ') + msg;
  el.className = `toast ${type} show`;
  setTimeout(() => el.classList.remove('show'), 3500);
}

/* â”€â”€ Generar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function generarFicha() {
  const url = document.getElementById('url').value.trim();
  if (!url) { toast('PegÃ¡ el link de la propiedad primero', 'err'); return; }

  const btn = document.getElementById('btn-generar');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner" style="border-top-color:white;width:16px;height:16px"></div> Procesando...';

  document.getElementById('log-card').style.display   = 'block';
  document.getElementById('result-card').style.display = 'none';
  document.getElementById('log-box').textContent = '';
  document.getElementById('log-spinner').style.display = 'block';
  document.getElementById('log-status').textContent = 'Procesando...';

  try {
    const res = await fetch('/api/generar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        url,
        nombre:   document.getElementById('g_nombre').value.trim(),
        whatsapp: document.getElementById('g_whatsapp').value.trim(),
        logo:     document.getElementById('g_logo').value.trim(),
        form_url: document.getElementById('g_form').value.trim(),
      }),
    });
    if (!res.ok) { toast('Error al iniciar el proceso', 'err'); resetBtn(); return; }
    const { job_id } = await res.json();
    escucharLogs(job_id);
  } catch(e) {
    toast('Error de red', 'err'); resetBtn();
  }
}

function escucharLogs(jobId) {
  const logBox = document.getElementById('log-box');
  const es = new EventSource(`/api/stream/${jobId}`);

  es.addEventListener('message', e => {
    logBox.textContent += e.data + '\n';
    logBox.scrollTop = logBox.scrollHeight;
  });

  es.addEventListener('done', e => {
    es.close();
    document.getElementById('log-spinner').style.display = 'none';
    document.getElementById('log-status').textContent = 'âœ“ Completado';
    resetBtn();
    const url = e.data.trim();
    if (url) {
      currentUrl = url;
      document.getElementById('result-link').textContent = url;
      document.getElementById('result-link').href = url;
      document.getElementById('result-card').style.display = 'block';
      document.getElementById('result-card').scrollIntoView({ behavior: 'smooth' });
    }
  });

  es.addEventListener('error', () => {
    es.close();
    logBox.textContent += '\nâŒ Error en el proceso\n';
    document.getElementById('log-spinner').style.display = 'none';
    document.getElementById('log-status').textContent = 'âœ— Error';
    resetBtn();
  });
}

function resetBtn() {
  const btn = document.getElementById('btn-generar');
  btn.disabled = false;
  btn.innerHTML = 'ğŸš€ Generar Ficha Ahora';
}

function copiarLink() {
  if (!currentUrl) return;
  navigator.clipboard.writeText(currentUrl).then(() => {
    const btn = document.getElementById('btn-copiar');
    btn.textContent = 'âœ“ Copiado';
    setTimeout(() => btn.textContent = 'ğŸ“‹ Copiar link', 2000);
  });
}

function abrirWpp() {
  if (!currentUrl) return;
  const nombre = document.getElementById('g_nombre').value.trim() || 'Tu asesor';
  const msg = `Â¡Hola! ğŸ‘‹ Te comparto la ficha de la propiedad:\n\nğŸ  ${currentUrl}\n\nCualquier consulta estoy a disposiciÃ³n. Saludos, ${nombre}`;
  window.open(`https://web.whatsapp.com/send?text=${encodeURIComponent(msg)}`, '_blank');
}

/* â”€â”€ Perfil â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function guardarPerfil() {
  const payload = {
    nombre:        document.getElementById('p_nombre').value.trim(),
    whatsapp:      document.getElementById('p_whatsapp').value.trim(),
    logo:          document.getElementById('p_logo').value.trim(),
    form_url:      document.getElementById('p_form').value.trim(),
    netlify_token: document.getElementById('p_netlify').value.trim(),
  };
  const res = await fetch('/api/perfil', {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
  });
  if (res.ok) {
    toast('Perfil guardado');
    document.getElementById('g_nombre').value   = payload.nombre;
    document.getElementById('g_whatsapp').value = payload.whatsapp;
    document.getElementById('g_logo').value     = payload.logo;
    document.getElementById('g_form').value     = payload.form_url;
  } else {
    toast('Error al guardar', 'err');
  }
}

/* â”€â”€ ContraseÃ±a â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function cambiarPassword() {
  const pw_actual    = document.getElementById('pw_actual').value;
  const pw_nueva     = document.getElementById('pw_nueva').value;
  const pw_confirmar = document.getElementById('pw_confirmar').value;
  if (pw_nueva !== pw_confirmar) { toast('Las contraseÃ±as no coinciden', 'err'); return; }
  if (pw_nueva.length < 6) { toast('MÃ­nimo 6 caracteres', 'err'); return; }
  const res = await fetch('/api/cambiar_password', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ pw_actual, pw_nueva })
  });
  const data = await res.json();
  if (res.ok) {
    toast('ContraseÃ±a actualizada');
    ['pw_actual','pw_nueva','pw_confirmar'].forEach(id => document.getElementById(id).value = '');
  } else {
    toast(data.error || 'Error', 'err');
  }
}

/* â”€â”€ Admin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
{% if is_admin %}
async function cargarUsuarios() {
  const res = await fetch('/api/admin/usuarios');
  const users = await res.json();
  document.getElementById('users-body').innerHTML = users.map(u => `
    <tr>
      <td><strong>${u.nombre || u.username}</strong></td>
      <td style="color:var(--muted);font-size:12px">${u.username}</td>
      <td><span class="badge ${u.role === 'admin' ? 'badge-admin' : 'badge-user'}">${u.role}</span></td>
      <td><span class="badge ${u.active ? 'badge-active' : 'badge-off'}">${u.active ? 'Activo' : 'Inactivo'}</span></td>
      <td>
        <div style="display:flex;gap:8px">
          ${u.username !== 'admin' ? `<button class="btn btn-ghost" style="padding:6px 12px;font-size:12px" onclick="toggleUser('${u.username}')">${u.active ? 'Desactivar' : 'Activar'}</button>` : ''}
          <button class="btn btn-ghost" style="padding:6px 12px;font-size:12px" onclick="abrirReset('${u.username}')">Reset pass</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function abrirModalCrear() {
  document.getElementById('modal-crear').classList.add('open');
  setTimeout(() => document.getElementById('new_nombre').focus(), 50);
}
function cerrarModal() { document.getElementById('modal-crear').classList.remove('open'); }

async function crearUsuario() {
  const nombre   = document.getElementById('new_nombre').value.trim();
  const username = document.getElementById('new_user').value.trim();
  const password = document.getElementById('new_pass').value.trim();
  if (!nombre || !username || !password) { toast('CompletÃ¡ todos los campos', 'err'); return; }
  const res = await fetch('/api/admin/crear_usuario', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ nombre, username, password })
  });
  const data = await res.json();
  if (res.ok) {
    cerrarModal();
    toast(`Usuario "${username}" creado`);
    cargarUsuarios();
    ['new_nombre','new_user','new_pass'].forEach(id => document.getElementById(id).value = '');
  } else {
    toast(data.error || 'Error', 'err');
  }
}

async function toggleUser(username) {
  const res = await fetch('/api/admin/toggle_usuario', {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ username })
  });
  if (res.ok) { cargarUsuarios(); toast('Usuario actualizado'); }
  else toast('Error', 'err');
}

function abrirReset(username) {
  resetTarget = username;
  document.getElementById('reset-label').textContent = username;
  document.getElementById('reset_pass').value = '';
  document.getElementById('modal-reset').classList.add('open');
  setTimeout(() => document.getElementById('reset_pass').focus(), 50);
}
function cerrarModalReset() { document.getElementById('modal-reset').classList.remove('open'); resetTarget = null; }

async function confirmarReset() {
  const password = document.getElementById('reset_pass').value.trim();
  if (password.length < 6) { toast('MÃ­nimo 6 caracteres', 'err'); return; }
  const res = await fetch('/api/admin/reset_password', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ username: resetTarget, password })
  });
  if (res.ok) { cerrarModalReset(); toast('ContraseÃ±a reseteada'); }
  else { const d = await res.json(); toast(d.error || 'Error', 'err'); }
}

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { cerrarModal(); cerrarModalReset(); }
});
{% endif %}
</script>
</body>
</html>
